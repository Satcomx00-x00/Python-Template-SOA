# ============================================================================
# GitHub Actions CI/CD Pipeline
# ============================================================================
# This workflow runs automated tests and checks on every push and pull request
# 
# Jobs performed:
# 1. Cleanup - Run make clean to ensure clean build environment
# 2. Syntax Check - Compile all Python files (py_compile)
# 3. Ruff Format & Lint - Check code formatting and linting
# 4. Security Scan - Run Bandit security scanner
# 5. Type Checking - Run mypy type checker
# 6. Tests - Run pytest with coverage
# 7. Changelog - Check changelog with git-cliff
#
# For more info: https://docs.github.com/en/actions
# ============================================================================

name: CI

# Trigger this workflow on push to any branch or pull request
on:
  push:
    branches: ["*"]  # Run on all branches
  pull_request:
    branches: ["*"]

# Cancel in-progress runs if a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Job 0: Cleanup
  # ==========================================================================
  cleanup:
    name: "Cleanup Build Artifacts"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run make clean
        run: |
          echo "üßπ Running make clean to remove build artifacts..."
          make clean
          echo "‚úÖ Cleanup complete!"

  # ==========================================================================
  # Job 1: Syntax Check (py_compile)
  # ==========================================================================
  syntax-check:
    name: "Python Syntax Check"
    runs-on: ubuntu-latest
    needs: cleanup
    
    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # Compile all Python files to check for syntax errors
      - name: Compile all Python files
        run: |
          echo "üîç Compiling all Python files to check syntax..."
          python -m py_compile $(find . -name "*.py" -not -path "./.venv/*" -not -path "./venv/*")
          echo "‚úÖ All Python files compiled successfully!"

  # ==========================================================================
  # Job 2: Ruff Format & Lint Check
  # ==========================================================================
  ruff:
    name: "Ruff Format & Lint"
    runs-on: ubuntu-latest
    needs: cleanup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install ruff
        run: |
          uv pip install --system ruff
      
      # Check code formatting (without modifying files)
      - name: Check code formatting with ruff
        run: |
          echo "üìê Checking code formatting..."
          ruff format --check src/ tests/
          echo "‚úÖ Code formatting check passed!"
      
      # Run ruff linter
      - name: Run ruff linter
        run: |
          echo "üßπ Running ruff linter..."
          ruff check src/ tests/
          echo "‚úÖ Linting passed!"

  # ==========================================================================
  # Job 3: Security Scan (Bandit)
  # ==========================================================================
  security-scan:
    name: "Security Scan (Bandit)"
    runs-on: ubuntu-latest
    needs: cleanup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # Install uv for fast dependency installation
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      # Install dependencies including bandit
      - name: Install dependencies
        run: |
          uv pip install --system bandit
      
      # Run Bandit security scanner
      - name: Run Bandit security scanner
        run: |
          echo "üîí Running Bandit security scanner..."
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f screen
          echo "‚úÖ Security scan complete!"
      
      # Upload Bandit report as artifact
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  # ==========================================================================
  # Job 4: Type Checking (mypy)
  # ==========================================================================
  typecheck:
    name: "Type Checking (mypy)"
    runs-on: ubuntu-latest
    needs: cleanup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          uv pip install --system mypy
      
      # Run mypy type checker
      - name: Run mypy type checker
        run: |
          echo "üîç Running mypy type checker..."
          mypy src/ tests/ || true
          echo "‚úÖ Type checking complete!"

  # ==========================================================================
  # Job 5: Tests (pytest)
  # ==========================================================================
  test:
    name: "Tests (pytest)"
    runs-on: ubuntu-latest
    needs: cleanup
    
    # Test matrix - run tests on multiple Python versions
    strategy:
      fail-fast: false  # Continue running other jobs if one fails
      matrix:
        python-version: ["3.11", "3.12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Set up Python from matrix
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      # Install all dependencies (including dev dependencies)
      - name: Install dependencies
        run: |
          uv pip install --system -e . pytest pytest-cov
      
      # Run tests with coverage
      - name: Run tests with coverage
        run: |
          echo "üß™ Running pytest with coverage..."
          pytest --cov=src --cov-report=xml --cov-report=term-missing
          echo "‚úÖ Tests passed!"
      
      # Upload coverage report to Codecov (optional - requires setup)
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     file: ./coverage.xml
      #     fail_ci_if_error: false
      
      # Upload coverage report as artifact
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: coverage.xml

  # ==========================================================================
  # Job 6: Changelog Check (git-cliff)
  # ==========================================================================
  changelog:
    name: "Changelog Check (git-cliff)"
    runs-on: ubuntu-latest
    needs: cleanup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git-cliff
      
      # Install git-cliff
      - name: Install git-cliff
        run: |
          echo "üì• Installing git-cliff..."
          curl -LsSf https://github.com/orhun/git-cliff/releases/latest/download/git-cliff-$(uname -m)-unknown-linux-gnu.tar.gz | tar xzf - -C /usr/local/bin
          echo "‚úÖ git-cliff installed!"
      
      # Generate changelog to verify configuration
      - name: Generate changelog
        run: |
          echo "üìã Generating changelog with git-cliff..."
          git-cliff --output CHANGELOG-PREVIEW.md
          echo "‚úÖ Changelog generated successfully!"
          echo ""
          echo "Preview of generated changelog:"
          head -n 50 CHANGELOG-PREVIEW.md
      
      # Upload generated changelog as artifact
      - name: Upload changelog preview
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: changelog-preview
          path: CHANGELOG-PREVIEW.md

  # ==========================================================================
  # Job 7: All Checks Passed
  # ==========================================================================
  all-checks:
    name: "All Checks Passed"
    runs-on: ubuntu-latest
    needs: [syntax-check, ruff, security-scan, typecheck, test, changelog]
    if: always()
    
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.syntax-check.result }}" != "success" ] || \
             [ "${{ needs.ruff.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.changelog.result }}" != "success" ]; then
            echo "‚ùå Some checks failed!"
            exit 1
          else
            echo "‚úÖ All checks passed successfully!"
          fi
